<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Naver Apt Briefing</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
      :root {
        --bg: #f4f6f8;
        --surface: #ffffff;
        --surface-soft: #e8edf2;
        --text: #0f1720;
        --muted: #5f6873;
        --accent: #0369a1;
        --accent-soft: #0ea5e9;
        --warn: #b45309;
        --border: #d5dbe3;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "IBM Plex Sans KR", sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 10% -10%, #bae6fd 0%, rgba(186, 230, 253, 0) 30%),
          radial-gradient(circle at 95% 0%, #fed7aa 0%, rgba(254, 215, 170, 0) 35%),
          var(--bg);
      }

      .container {
        width: min(1200px, 94vw);
        margin: 24px auto 56px;
      }

      .headline {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 16px;
        margin-bottom: 22px;
      }

      .headline h1 {
        margin: 0;
        font-family: "Space Grotesk", sans-serif;
        font-size: clamp(1.4rem, 2.5vw, 2rem);
        letter-spacing: -0.02em;
      }

      .headline p {
        margin: 6px 0 0;
        color: var(--muted);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
      }

      .panel {
        grid-column: span 12;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 10px 20px rgba(15, 23, 32, 0.04);
      }

      .panel h2 {
        margin: 0 0 10px;
        font-size: 1rem;
        font-family: "Space Grotesk", sans-serif;
      }

      .panel.two {
        grid-column: span 6;
      }

      .panel.four {
        grid-column: span 4;
      }

      .panel.six {
        grid-column: span 6;
      }

      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .row button {
        flex: 0 0 auto;
      }

      .fields {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 8px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .field label {
        color: var(--muted);
        font-size: 0.82rem;
        font-weight: 600;
      }

      input,
      button,
      textarea {
        font: inherit;
      }

      input,
      textarea {
        width: 100%;
        padding: 10px 11px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
      }

      button {
        padding: 10px 14px;
        border: 0;
        border-radius: 10px;
        background: var(--accent);
        color: #fff;
        cursor: pointer;
        font-weight: 600;
      }

      button.alt {
        background: #0b2535;
      }

      button.warn {
        background: var(--warn);
      }

      .split {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .muted {
        color: var(--muted);
        font-size: 0.92rem;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 4px 10px;
        background: var(--surface-soft);
        margin-right: 6px;
        margin-bottom: 6px;
        font-size: 0.88rem;
      }

      .list {
        max-height: 180px;
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px;
      }

      .status {
        margin-top: 8px;
        color: var(--muted);
        font-size: 0.9rem;
        min-height: 20px;
        line-height: 1.45;
      }

      .auth-controls {
        display: none;
      }

      .auth-controls.active {
        display: block;
      }

      .hint {
        margin-top: 8px;
        color: var(--muted);
        font-size: 0.88rem;
        line-height: 1.45;
      }

      .chart-wrap {
        position: relative;
        width: 100%;
        height: 360px;
        margin-top: 8px;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px;
        background: #fff;
      }

      .chart-wrap canvas {
        width: 100% !important;
        height: 100% !important;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table th,
      .table td {
        text-align: left;
        padding: 8px 6px;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
        vertical-align: top;
      }

      .scroll-table {
        overflow: auto;
        margin-top: 8px;
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      }

      .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: #e0f2fe;
        color: #0c4a6e;
        font-size: 0.78rem;
        font-weight: 600;
      }

      .panel.slim {
        padding-top: 12px;
        padding-bottom: 12px;
      }

      .panel.slim h2 {
        margin-bottom: 8px;
      }

      @media (max-width: 960px) {
        .panel.two,
        .panel.four,
        .panel.six {
          grid-column: span 12;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="headline">
        <div>
          <h1>Naver Apt Briefing Dashboard</h1>
          <p>관심 단지 수집, 추세/비교 차트, 급매 후보를 한 화면에서 확인합니다.</p>
        </div>
        <div id="userBadge" class="pill">로그인 필요</div>
      </div>

      <div class="grid">
        <section class="panel four slim">
          <h2>1) 계정</h2>
          <div id="authGuestControls" class="auth-controls active">
            <div class="fields">
              <div class="field">
                <label for="email">이메일 (로그인 ID)</label>
                <input id="email" type="email" placeholder="email@example.com" />
              </div>
              <div class="field">
                <label for="password">비밀번호</label>
                <input id="password" type="password" placeholder="8자 이상" />
              </div>
              <div class="field">
                <label for="inviteCode">가입 승인 코드 (선택)</label>
                <input id="inviteCode" type="text" placeholder="운영자가 설정한 경우에만 입력" />
              </div>
            </div>
            <div class="row" style="margin-top: 8px">
              <button id="registerBtn">회원가입</button>
              <button id="loginBtn" class="alt">로그인</button>
            </div>
            <div class="hint">
              운영자가 가입 승인 코드를 설정한 경우에만 입력하세요. 미설정 환경에서는 비워둬도 회원가입됩니다.
            </div>
          </div>
          <div id="authUserControls" class="auth-controls">
            <div class="row">
              <div id="authEmailDisplay" class="pill">로그인 사용자</div>
              <div id="billingPlanBadge" class="pill">플랜: 확인 필요</div>
            </div>
            <div class="row" style="margin-top: 8px">
              <button id="meBtn" class="alt">내 정보 새로고침</button>
              <button id="logoutBtn" class="warn">로그아웃</button>
            </div>
          </div>
          <div class="status" id="authStatus"></div>
        </section>

        <section class="panel six">
          <h2>2) 관심 단지 등록</h2>
          <div class="row" style="margin-top: 8px">
            <input id="watchComplexKeyword" type="text" placeholder="단지명 검색 (2자 이상)" />
            <button id="searchComplexBtn" class="alt">단지명 검색</button>
          </div>
          <div class="list" id="watchComplexSearchList" style="margin-top: 8px"></div>
          <div class="row" style="margin-top: 8px">
            <input id="watchComplexUrl" type="text" placeholder="네이버 단지 URL 또는 단지 번호" />
            <button id="parseComplexUrlBtn" class="alt">URL에서 단지 번호 추출</button>
          </div>
          <div class="fields">
            <div class="field">
              <label for="watchComplexNo">단지 번호</label>
              <input id="watchComplexNo" type="number" placeholder="예: 2977" />
            </div>
            <div class="field">
              <label for="watchComplexName">단지명 (선택)</label>
              <input id="watchComplexName" type="text" placeholder="예: 래미안 대치 팰리스" />
            </div>
          </div>
          <div class="row" style="margin-top: 8px">
            <button id="addWatchBtn">등록</button>
            <button id="loadWatchBtn" class="alt">목록 조회</button>
          </div>
          <div class="hint">
            단지 번호는 단지 URL `.../complexes/2977`의 숫자값입니다. 단지명 검색 결과를 클릭하면 자동 입력됩니다.
          </div>
          <div class="scroll-table">
            <table class="table">
              <thead>
                <tr>
                  <th>단지 번호</th>
                  <th>단지명</th>
                  <th>위치</th>
                  <th>등록일</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody id="watchBody"></tbody>
            </table>
          </div>
          <div class="status" id="watchStatus"></div>
        </section>

        <section class="panel six">
          <h2>2-1) 실시간 매물 조회</h2>
          <div class="fields" style="margin-top: 8px">
            <div class="field">
              <label for="liveWatchPage">조회 페이지</label>
              <input id="liveWatchPage" type="number" value="1" min="1" placeholder="1" />
            </div>
            <div class="field">
              <label for="liveWatchMax">단지당 최대 매물 수</label>
              <input id="liveWatchMax" type="number" value="10" min="1" max="30" placeholder="10 (최대 30)" />
            </div>
          </div>
          <div class="row" style="margin-top: 8px">
            <button id="loadLiveWatchBtn" class="warn">실시간 매물 조회</button>
          </div>
          <div class="fields" style="margin-top: 8px">
            <div class="field">
              <label for="liveFilterKeyword">매물 검색어</label>
              <input id="liveFilterKeyword" type="text" placeholder="단지명/매물명" />
            </div>
            <div class="field">
              <label for="liveFilterTradeType">거래유형</label>
              <input id="liveFilterTradeType" type="text" placeholder="예: 매매, 전세, 월세" />
            </div>
            <div class="field">
              <label for="liveFilterMaxPrice">최대 매매가(만원, 선택)</label>
              <input id="liveFilterMaxPrice" type="number" min="0" step="1" placeholder="예: 150000" />
            </div>
          </div>
          <div class="hint">
            조회 페이지는 네이버 매물 페이지 번호입니다. 필터는 현재 화면에 표시된 실시간 조회 결과에 즉시 적용됩니다.
          </div>
          <div class="scroll-table">
            <table class="table">
              <thead>
                <tr>
                  <th>단지</th>
                  <th>매물번호</th>
                  <th>매물명</th>
                  <th>거래유형</th>
                  <th>가격</th>
                  <th>층/방향</th>
                </tr>
              </thead>
              <tbody id="liveWatchBody"></tbody>
            </table>
          </div>
          <div class="status" id="liveWatchStatus"></div>
        </section>

        <section class="panel six">
          <h2>2-2) 수집 이력 / 자동수집 상태</h2>
          <div class="row">
            <button id="loadCollectionStatusBtn" class="alt">수집 상태 조회</button>
          </div>
          <div class="hint" id="collectionAutoCollectHint">
            자동수집 정보 로딩 전입니다. 버튼을 눌러 현재 스케줄과 관심 단지별 최신 수집 시각을 확인하세요.
          </div>
          <div class="scroll-table">
            <table class="table">
              <thead>
                <tr>
                  <th>단지 번호</th>
                  <th>단지명</th>
                  <th>최신 수집 시각</th>
                  <th>최신 수집 건수</th>
                  <th>마지막 시도 상태</th>
                  <th>자동수집 대상</th>
                </tr>
              </thead>
              <tbody id="collectionStatusBody"></tbody>
            </table>
          </div>
          <div class="status" id="collectionStatusNote"></div>
        </section>

        <section class="panel four">
          <h2>3) 데이터 새로고침 (수동)</h2>
          <div class="fields">
            <div class="field">
              <label for="ingestComplexNo">단지 번호</label>
              <input id="ingestComplexNo" type="number" placeholder="예: 2977" />
            </div>
            <div class="field">
              <label for="ingestPage">수집 시작 페이지</label>
              <input id="ingestPage" type="number" value="1" min="1" />
            </div>
          </div>
          <div class="row" style="margin-top: 8px">
            <button id="ingestBtn">데이터 새로고침</button>
            <button id="metaBtn" class="alt">운영 정보 확인</button>
          </div>
          <div class="hint">수집 시작 페이지를 1로 두면 최신 매물을 먼저 수집합니다.</div>
          <div class="status" id="ingestStatus"></div>
        </section>

        <section class="panel four">
          <h2>4) 요금제 / 더미 결제</h2>
          <div class="row"><span class="tag">결제 테스트 모드</span></div>
          <div class="row" style="margin-top: 8px">
            <button id="billingMeBtn">내 플랜 조회</button>
            <button id="billingCheckoutBtn" class="alt">PRO 결제 시작(더미)</button>
          </div>
          <div class="row" style="margin-top: 8px">
            <input id="billingCheckoutToken" type="text" placeholder="checkout_token (자동 입력)" />
            <button id="billingCompleteBtn" class="warn">결제 완료 처리</button>
          </div>
          <div class="status" id="billingStatus"></div>
        </section>

        <section class="panel">
          <h2>5) 알림 채널 설정 (이메일/텔레그램)</h2>
          <div class="split">
            <input id="notifyEmailAddress" type="email" placeholder="알림 이메일 주소" />
            <input id="notifyTelegramChatId" type="text" placeholder="텔레그램 chat_id" />
          </div>
          <div class="row" style="margin-top: 8px">
            <label class="pill"><input id="notifyEmailEnabled" type="checkbox" /> 이메일 사용</label>
            <label class="pill"><input id="notifyTelegramEnabled" type="checkbox" /> 텔레그램 사용</label>
            <label class="pill"><input id="notifyBargainEnabled" type="checkbox" checked /> 급매 알림 사용</label>
          </div>
          <div class="fields" style="margin-top: 8px">
            <div class="field">
              <label for="notifyLookbackDays">탐지 기간(일)</label>
              <input id="notifyLookbackDays" type="number" min="1" max="180" value="30" placeholder="30" />
            </div>
            <div class="field">
              <label for="notifyDiscountThreshold">할인율 임계값 (비율)</label>
              <input
                id="notifyDiscountThreshold"
                type="number"
                step="0.01"
                min="0.01"
                max="0.99"
                value="0.08"
                placeholder="0.08 = 8%"
              />
            </div>
          </div>
          <div class="hint">예: 기간 30일, 임계값 0.08이면 최근 30일 중앙값 대비 8% 이상 낮은 매물을 급매로 판단합니다.</div>
          <div class="row" style="margin-top: 8px">
            <button id="loadNotifyBtn">설정 조회</button>
            <button id="saveNotifyBtn" class="alt">설정 저장</button>
            <button id="dispatchAlertBtn" class="warn">지금 알림 발송</button>
          </div>
          <div class="status" id="notifyStatus"></div>
        </section>

        <section class="panel">
          <h2>6) 단지 시세 추세</h2>
          <div class="fields">
            <div class="field">
              <label for="trendComplexNo">단지 번호</label>
              <input id="trendComplexNo" type="number" placeholder="예: 2977" />
            </div>
            <div class="field">
              <label for="trendDays">조회 기간(일)</label>
              <input id="trendDays" type="number" value="30" min="1" />
            </div>
          </div>
          <div class="row" style="margin-top: 8px">
            <button id="loadTrendBtn">차트 조회</button>
          </div>
          <div class="hint">최근 N일 동안 수집된 매물의 일자별 평균 시세를 표시합니다.</div>
          <div class="chart-wrap">
            <canvas id="trendChart"></canvas>
          </div>
          <div class="status" id="trendStatus"></div>
        </section>

        <section class="panel">
          <h2>7) 선택 단지 비교</h2>
          <div class="fields">
            <div class="field">
              <label for="compareComplexNos">비교 단지 번호 목록</label>
              <input id="compareComplexNos" type="text" placeholder="예: 12345,23456,34567" />
            </div>
            <div class="field">
              <label for="compareDays">조회 기간(일)</label>
              <input id="compareDays" type="number" value="30" min="1" />
            </div>
          </div>
          <div class="row" style="margin-top: 8px">
            <button id="loadCompareBtn">비교 조회</button>
          </div>
          <div class="hint">쉼표로 구분한 여러 단지의 일자별 평균 시세를 한 그래프에서 비교합니다.</div>
          <div class="chart-wrap">
            <canvas id="compareChart"></canvas>
          </div>
          <div class="status" id="compareStatus"></div>
        </section>

        <section class="panel">
          <h2>8) 급매 후보</h2>
          <div class="fields">
            <div class="field">
              <label for="bargainComplexNo">단지 번호</label>
              <input id="bargainComplexNo" type="number" placeholder="예: 2977" />
            </div>
            <div class="field">
              <label for="bargainDays">기준 기간(일)</label>
              <input id="bargainDays" type="number" value="30" min="1" />
            </div>
            <div class="field">
              <label for="bargainThreshold">할인율 기준 (비율)</label>
              <input id="bargainThreshold" type="number" step="0.01" value="0.08" min="0" max="0.99" />
            </div>
          </div>
          <div class="row" style="margin-top: 8px">
            <button id="loadBargainBtn">탐지</button>
            <button id="loadMyBargainBtn" class="alt">내 관심단지 알림</button>
          </div>
          <div class="hint">
            급매 탐지는 최근 N일 가격 중앙값 대비 현재 매물 가격이 임계값 이상 낮은 경우를 찾습니다. 예: 0.08은 8% 할인입니다.
            ‘내 관심단지 알림’은 로그인한 계정의 관심 단지 전체를 같은 규칙으로 한 번에 탐지합니다.
          </div>
          <div class="status" id="bargainStatus"></div>
          <div style="overflow: auto; margin-top: 8px">
            <table class="table">
              <thead>
                <tr>
                  <th>단지</th>
                  <th>매물번호</th>
                  <th>매물명</th>
                  <th>유형</th>
                  <th>가격</th>
                  <th>기준중앙값(만원)</th>
                  <th>할인율</th>
                </tr>
              </thead>
              <tbody id="bargainBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
    <script src="/web/app.js"></script>
  </body>
</html>
